<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#1a202c',
                            800: '#2d3748',
                            700: '#4a5568',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans antialiased h-screen flex flex-col">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-96 border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center text-green-500">MC Manager Login</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username (any)"
                    class="w-full bg-gray-700 text-white border border-gray-600 rounded p-3 mb-4 focus:outline-none focus:border-green-500"
                    value="admin">
                <input type="password" id="password" placeholder="Password"
                    class="w-full bg-gray-700 text-white border border-gray-600 rounded p-3 mb-6 focus:outline-none focus:border-green-500">
                <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded transition duration-200">Login</button>
            </form>
            <p id="login-error" class="text-red-500 mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="hidden flex-1 flex flex-col">
        <!-- Header -->
        <header
            class="bg-gray-800 shadow-md p-4 flex justify-between items-center border-b border-gray-700 z-10 shrink-0">
            <div class="flex items-center">
                <button onclick="toggleSidebar()"
                    class="md:hidden mr-3 text-gray-300 hover:text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-green-500">MC Manager</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="server-status"
                    class="px-3 py-1 rounded-full text-xs font-bold bg-gray-600 text-gray-300">OFFLINE</span>
                <span class="text-gray-400 text-sm hidden sm:inline">CPU: <span id="cpu-stat">0%</span></span>
                <span class="text-gray-400 text-sm hidden sm:inline">RAM: <span id="ram-stat">0 MB</span></span>
                <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300">Logout</button>
            </div>
        </header>

        <!-- Main Body -->
        <div class="flex-1 flex overflow-hidden relative">
            <!-- Mobile Overlay -->
            <div id="sidebar-overlay" onclick="toggleSidebar()"
                class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

            <!-- Sidebar -->
            <nav id="sidebar"
                class="absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 w-64 bg-gray-800 border-r border-gray-700 flex flex-col p-4 space-y-2 h-full">
                <button onclick="showUnimplemented('dashboard')"
                    class="bg-gray-700 hover:bg-gray-600 text-left px-4 py-2 rounded text-white active-nav"
                    data-tab="dashboard">Dashboard & Console</button>
                <button onclick="showUnimplemented('settings')"
                    class="hover:bg-gray-700 text-left px-4 py-2 rounded text-gray-300"
                    data-tab="settings">Settings</button>
                <button onclick="showUnimplemented('files')"
                    class="hover:bg-gray-700 text-left px-4 py-2 rounded text-gray-300" data-tab="files">File
                    Editor</button>
                <button onclick="showUnimplemented('backups')"
                    class="hover:bg-gray-700 text-left px-4 py-2 rounded text-gray-300"
                    data-tab="backups">Backups</button>
                <button onclick="showUnimplemented('logs')"
                    class="hover:bg-gray-700 text-left px-4 py-2 rounded text-gray-300" data-tab="logs">Log
                    History</button>
            </nav>

            <!-- Content Area -->
            <main class="flex-1 bg-gray-900 p-6 overflow-y-auto custom-scroll">

                <!-- Dashboard View -->
                <div id="view-dashboard" class="space-y-6">
                    <!-- Controls -->
                    <div class="flex space-x-4">
                        <button onclick="startServer()"
                            class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded font-bold shadow-lg transition">Start</button>
                        <button onclick="stopServer()"
                            class="bg-yellow-600 hover:bg-yellow-700 px-6 py-2 rounded font-bold shadow-lg transition">Stop</button>
                        <button onclick="sendCommand('kill')"
                            class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold shadow-lg transition">Kill</button>
                    </div>

                    <!-- Console -->
                    <div class="bg-black rounded-lg border border-gray-700 shadow-2xl flex flex-col h-[600px]">
                        <div class="bg-gray-800 px-4 py-2 text-xs text-gray-400 border-b border-gray-700 font-mono">
                            Server Console</div>
                        <div id="console-output"
                            class="flex-1 p-4 font-mono text-sm overflow-y-auto custom-scroll text-gray-300 whitespace-pre-wrap">
                        </div>
                        <div class="p-2 bg-gray-800 border-t border-gray-700">
                            <form onsubmit="handleConsoleCommand(event)" class="flex">
                                <input type="text" id="console-input"
                                    class="flex-1 bg-gray-900 border border-gray-600 rounded-l px-3 py-2 text-white focus:outline-none focus:border-green-500 font-mono"
                                    placeholder="Type a command...">
                                <button type="submit"
                                    class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-r font-bold">Send</button>
                            </form>
                        </div>
                    </div>
                    <!-- Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-48">
                        <div class="bg-gray-800 rounded p-4 border border-gray-700 relative">
                            <canvas id="cpuChart"></canvas>
                        </div>
                        <div class="bg-gray-800 rounded p-4 border border-gray-700 relative">
                            <canvas id="ramChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="hidden space-y-6 max-w-2xl">
                    <h2 class="text-2xl font-bold mb-4">Server Configuration</h2>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Server Name</label>
                            <input id="set-server-name" type="text"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">RAM Min (-Xms)</label>
                                <input id="set-ram-min" type="text"
                                    class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">RAM Max (-Xmx)</label>
                                <input id="set-ram-max" type="text"
                                    class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Java Path</label>
                            <input id="set-java-path" type="text"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Jar File Path</label>
                            <input id="set-jar-path" type="text"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Server Working Directory</label>
                            <input id="set-server-dir" type="text"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Backup Path</label>
                            <input id="set-backup-path" type="text"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <button onclick="saveSettings()"
                            class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-bold w-full">Save
                            Settings</button>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
                        <h3 class="text-xl font-bold">Security</h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Current Password</label>
                            <input id="sec-current-pass" type="password"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">New Password</label>
                            <input id="sec-new-pass" type="password"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        </div>
                        <button onclick="changePassword()"
                            class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold w-full">Change
                            Password</button>
                    </div>
                </div>

                <!-- Files View -->
                <div id="view-files" class="hidden space-y-6 max-w-4xl h-full flex flex-col">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">File Editor (server.properties)</h2>
                        <button onclick="saveFile()" class="bg-blue-600 px-4 py-2 rounded text-sm">Save Changes</button>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <input id="file-path" type="text" value="server.properties"
                            class="bg-gray-800 border border-gray-700 p-2 mb-2 text-gray-300 w-full"
                            placeholder="Filename relative to server dir">
                        <textarea id="file-content"
                            class="flex-1 bg-gray-900 border border-gray-700 font-mono text-sm p-4 rounded text-gray-300 focus:outline-none custom-scroll"></textarea>
                    </div>
                </div>

                <!-- Backups View -->
                <div id="view-backups" class="hidden space-y-6 max-w-4xl">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold">Backups</h2>
                            <p class="text-xs text-gray-400 mt-1">Storage: <span id="backup-usage">Loading...</span></p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="createBackup('world')"
                                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-bold">Backup
                                World</button>
                            <button onclick="createBackup('full')"
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold">Full
                                Backup</button>
                        </div>
                    </div>

                    <!-- Progress Bar (Initially Hidden) -->
                    <div id="backup-progress-container"
                        class="hidden bg-gray-800 p-4 rounded border border-gray-700 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-sm text-gray-400">
                                <span id="backup-status-text">Starting...</span>
                                (<span id="backup-percent">0%</span>)
                            </div>
                            <button onclick="cancelBackup()"
                                class="text-xs text-red-400 hover:text-red-300 border border-red-500 rounded px-2 py-1">Cancel</button>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="backup-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700 text-gray-300">
                                <tr>
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Size</th>
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list" class="divide-y divide-gray-700 text-sm">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Logs View -->
                <div id="view-logs" class="hidden space-y-6 max-w-4xl h-full flex flex-col">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Log History (logs/latest.log)</h2>
                        <button onclick="loadLogs()" class="bg-blue-600 px-4 py-2 rounded text-sm">Refresh</button>
                    </div>
                    <div
                        class="flex-1 flex flex-col bg-black rounded-lg border border-gray-700 shadow-2xl overflow-hidden h-96">
                        <pre id="log-content"
                            class="flex-1 p-4 font-mono text-xs text-gray-300 custom-scroll overflow-y-auto whitespace-pre-wrap"></pre>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('access_token');
        let ws = null;

        // --- Init ---
        if (token) {
            showApp();
        }

        // --- Auth ---
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const res = await fetch('/token', { method: 'POST', body: formData });
                if (res.status === 429) throw new Error('Too many attempts. Wait 5 minutes.');
                if (!res.ok) throw new Error('Invalid credentials');
                const data = await res.json();
                token = data.access_token;
                localStorage.setItem('access_token', token);
                showApp();
            } catch (err) {
                errorMsg.innerText = err.message;
                errorMsg.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            location.reload();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function showApp() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            startStatsLoop();
            connectWS();
            loadSettings(); // Preload
        }

        // --- Navigation ---
        function showUnimplemented(tab) {
            // Hide all views
            ['dashboard', 'settings', 'files', 'backups', 'logs'].forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden');
            });
            // Show selected
            const target = document.getElementById('view-' + tab);
            if (target) target.classList.remove('hidden');

            // Update Tab styles
            document.querySelectorAll('nav button').forEach(b => {
                if (b.dataset.tab === tab) {
                    b.classList.add('bg-gray-700', 'text-white');
                    b.classList.remove('text-gray-300');
                } else {
                    b.classList.remove('bg-gray-700', 'text-white');
                    b.classList.add('text-gray-300');
                }
            });

            // Close sidebar on mobile
            if (window.innerWidth < 768) {
                toggleSidebar();
            }

            if (tab === 'files') loadFile();
            if (tab === 'backups') loadBackups();
            if (tab === 'logs') loadLogs();
            if (tab === 'settings') loadSettings();
        }

        // --- API Helpers ---
        async function api(url, method = 'GET', body = null) {
            const opts = {
                method,
                headers: { 'Authorization': 'Bearer ' + token }
            };
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
            const res = await fetch('/api' + url, opts);
            if (res.status === 401) logout();
            return res.json();
        }

        // --- Logic ---
        // Charts
        let cpuChart, ramChart;

        function initCharts() {
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';

            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { display: false } // Hide x labels for cleaner look
                    },
                    plugins: { legend: { display: false }, title: { display: true, text: 'CPU Usage' } }
                }
            });

            ramChart = new Chart(document.getElementById('ramChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'RAM Usage (MB)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false }, title: { display: true, text: 'RAM Usage' } }
                }
            });
        }

        function updateCharts(cpu, ram) {
            const now = new Date().toLocaleTimeString();

            // CPU
            cpuChart.data.labels.push(now);
            cpuChart.data.datasets[0].data.push(cpu);
            if (cpuChart.data.labels.length > 20) {
                cpuChart.data.labels.shift();
                cpuChart.data.datasets[0].data.shift();
            }
            cpuChart.update();

            // RAM
            // Parse "123.4 MB" -> 123.4
            const ramVal = parseFloat(ram);
            ramChart.data.labels.push(now);
            ramChart.data.datasets[0].data.push(ramVal);
            if (ramChart.data.labels.length > 20) {
                ramChart.data.labels.shift();
                ramChart.data.datasets[0].data.shift();
            }
            ramChart.update();
        }

        function startStatsLoop() {
            initCharts();
            setInterval(async () => {
                try {
                    const stats = await api('/stats');
                    document.getElementById('cpu-stat').innerText = stats.cpu + '%';
                    document.getElementById('ram-stat').innerText = stats.ram;

                    updateCharts(stats.cpu, stats.ram);

                    const badge = document.getElementById('server-status');
                    if (stats.status === 'online') {
                        badge.innerText = 'ONLINE';
                        badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white';
                    } else {
                        badge.innerText = 'OFFLINE';
                        badge.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-600 text-white';
                    }
                } catch (e) { console.error(e); }
            }, 2000);
        }

        async function startServer() {
            const res = await api('/start', 'POST');
            if (res.status === 'error') alert("Error: " + res.message);
        }
        async function stopServer() {
            const res = await api('/stop', 'POST');
            if (res.status === 'error') alert("Error: " + res.message);
        }
        async function sendCommand(cmd) {
            // Reuse for custom commands
            await api('/command', 'POST', { command: cmd });
        }

        async function handleConsoleCommand(e) {
            e.preventDefault();
            const input = document.getElementById('console-input');
            const cmd = input.value;
            if (cmd) {
                await sendCommand(cmd);
                input.value = '';
            }
        }

        function connectWS() {
            // WS connection
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(protocol + '://' + window.location.host + '/ws/console?token=' + encodeURIComponent(token));
            ws.onmessage = function (event) {
                const consoleDiv = document.getElementById('console-output');
                consoleDiv.innerText += event.data;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            };
            ws.onclose = () => setTimeout(connectWS, 3000);
        }

        async function loadSettings() {
            const s = await api('/settings');
            document.getElementById('set-server-name').value = s.server_name;
            document.getElementById('set-ram-min').value = s.ram_min;
            document.getElementById('set-ram-max').value = s.ram_max;
            document.getElementById('set-java-path').value = s.java_path;
            document.getElementById('set-jar-path').value = s.jar_path;
            document.getElementById('set-server-dir').value = s.server_dir;
            document.getElementById('set-backup-path').value = s.backup_path || "./backups";
        }

        async function saveSettings() {
            const s = {
                server_name: document.getElementById('set-server-name').value,
                ram_min: document.getElementById('set-ram-min').value,
                ram_max: document.getElementById('set-ram-max').value,
                java_path: document.getElementById('set-java-path').value,
                jar_path: document.getElementById('set-jar-path').value,
                server_dir: document.getElementById('set-server-dir').value,
                backup_path: document.getElementById('set-backup-path').value,
            };
            await api('/settings', 'POST', s);
            alert('Settings saved!');
        }

        async function changePassword() {
            const current = document.getElementById('sec-current-pass').value;
            const newp = document.getElementById('sec-new-pass').value;
            const res = await api('/change-password', 'POST', { current_password: current, new_password: newp });
            if (res.status === 'success') {
                alert('Password changed!');
                document.getElementById('sec-current-pass').value = '';
                document.getElementById('sec-new-pass').value = '';
            } else {
                alert('Error: ' + (res.detail || 'Unknown error'));
            }
        }

        // Files
        async function loadFile() {
            const path = document.getElementById('file-path').value;
            const res = await api('/file?path=' + encodeURIComponent(path));
            document.getElementById('file-content').value = res.content || '';
        }

        // Bind loadFile to input enter or blur
        document.getElementById('file-path').addEventListener('blur', loadFile);

        async function saveFile() {
            const path = document.getElementById('file-path').value;
            const content = document.getElementById('file-content').value;
            await api('/file?path=' + encodeURIComponent(path), 'POST', { command: content });
            alert('File saved!');
        }

        // Backups
        async function loadBackups() {
            // Load list
            const list = await api('/backups');
            const tbody = document.getElementById('backup-list');
            tbody.innerHTML = '';
            list.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${b.name}</td>
                    <td class="p-3">${(b.size / 1024 / 1024).toFixed(2)} MB</td>
                    <td class="p-3">${new Date(b.created).toLocaleString()}</td>
                    <td class="p-3">
                        <button onclick="deleteBackup('${b.name}')" class="text-red-400 hover:text-red-300">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Load Usage
            try {
                const usage = await api('/backups/usage');
                const percent = Math.round((usage.used_gb / usage.total_gb) * 100);
                document.getElementById('backup-usage').innerText =
                    `${usage.free_gb} GB free / ${usage.total_gb} GB total (${percent}% used)`;
            } catch (e) {
                console.error(e);
            }
        }

        async function createBackup(type) {
            if (!confirm(`Create ${type} backup? This might lag the server.`)) return;

            // disable buttons
            document.querySelectorAll('#view-backups button').forEach(b => b.disabled = true);

            const res = await api(`/backups?type=${type}`, 'POST');
            if (res.status === 'started') {
                // Show progress bar
                document.getElementById('backup-progress-container').classList.remove('hidden');
                pollBackupStatus();
            } else {
                alert(res.message);
                document.querySelectorAll('#view-backups button').forEach(b => b.disabled = false);
            }
        }

        async function pollBackupStatus() {
            const container = document.getElementById('backup-progress-container');
            const statusText = document.getElementById('backup-status-text');
            const percentText = document.getElementById('backup-percent');
            const bar = document.getElementById('backup-bar');

            const interval = setInterval(async () => {
                const s = await api('/backups/status');

                if (s.state === 'running') {
                    statusText.innerText = s.message || "Working...";
                    percentText.innerText = s.progress + '%';
                    bar.style.width = s.progress + '%';
                } else {
                    clearInterval(interval);
                    // Finished (success or error)
                    statusText.innerText = s.message;
                    percentText.innerText = s.state === 'success' ? '100%' : 'Error';
                    bar.style.width = s.state === 'success' ? '100%' : '0%';
                    bar.className = s.state === 'success' ? 'bg-green-500 h-2.5 rounded-full' : 'bg-red-500 h-2.5 rounded-full';

                    setTimeout(() => {
                        container.classList.add('hidden');
                        bar.className = 'bg-blue-600 h-2.5 rounded-full'; // reset
                        document.querySelectorAll('#view-backups button').forEach(b => b.disabled = false);
                        loadBackups();
                    }, 3000);
                }
            }, 1000);
        }

        async function cancelBackup() {
            if (!confirm("Cancel running backup? The archive will be deleted.")) return;
            const res = await api('/backups/cancel', 'POST');
            if (res.status === 'error') alert(res.message);
        }

        async function deleteBackup(name) {
            if (!confirm("Delete " + name + "?")) return;
            await api('/backups/' + name, 'DELETE');
            loadBackups();
        }

        // Logs
        async function loadLogs() {
            const res = await api('/logs?lines=500');
            document.getElementById('log-content').innerText = res.content;
        }

    </script>
</body>

</html>